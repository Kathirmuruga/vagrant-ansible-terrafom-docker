---
- name: Install GitHub Actions Runner
  hosts: all
  become: yes

  vars:
    # github_repo: "deenamanick/vagrant-ansible-terrafom-docker"
    github_repo: "{{ lookup('env','GITHUB_REPO') }}"
    runner_version: "2.328.0"
    runner_dir: "/opt/actions-runner"
    github_pat: "{{ lookup('env','GITHUB_PAT') }}"
    cache_dir: "/home/vagrant/ansible/cache"   # cache on controller

  pre_tasks:
    - name: Ensure cache dir exists on controller
      delegate_to: localhost
      file:
        path: "{{ cache_dir }}"
        state: directory
        mode: '0755'

    - name: Download runner once to controller cache (with retries)
      delegate_to: localhost
      get_url:
        url: "https://github.com/actions/runner/releases/download/v{{ runner_version }}/actions-runner-linux-x64-{{ runner_version }}.tar.gz"
        dest: "{{ cache_dir }}/actions-runner-linux-x64-{{ runner_version }}.tar.gz"
        mode: '0644'
        timeout: 600
      register: download_result
      retries: 5
      delay: 20
      until: download_result is succeeded

  tasks:
    - name: Install dependencies
      apt:
        name: [ "curl", "tar", "jq", "ca-certificates" ]
        state: present
        update_cache: yes

    - name: Create runner directory on target
      file:
        path: "{{ runner_dir }}"
        state: directory
        owner: vagrant
        group: vagrant
        mode: '0755'

    - name: Copy cached runner tarball to target
      copy:
        src: "{{ cache_dir }}/actions-runner-linux-x64-{{ runner_version }}.tar.gz"
        dest: "{{ runner_dir }}/runner.tar.gz"
        mode: '0644'

    - name: Extract GitHub runner
      unarchive:
        src: "{{ runner_dir }}/runner.tar.gz"
        dest: "{{ runner_dir }}"
        remote_src: yes
        creates: "{{ runner_dir }}/config.sh"

    - name: Ensure runner directory owned by vagrant
      file:
        path: "{{ runner_dir }}"
        state: directory
        recurse: yes
        owner: vagrant
        group: vagrant

    - name: Request registration token from GitHub API (with retries)
      uri:
        url: "https://api.github.com/repos/{{ github_repo }}/actions/runners/registration-token"
        method: POST
        headers:
          Authorization: "token {{ github_pat }}"
          Accept: "application/vnd.github.v3+json"
        status_code: 201
        timeout: 60
      register: reg_token
      retries: 5
      delay: 10
      until: reg_token.status == 201

    - name: Configure GitHub runner
      command: >
        ./config.sh --url https://github.com/{{ github_repo }}
        --token {{ reg_token.json.token }} --unattended
      args:
        chdir: "{{ runner_dir }}"
      become_user: vagrant

    - name: Install runner as service
      command: ./svc.sh install
      args:
        chdir: "{{ runner_dir }}"

    - name: Start runner service
      command: ./svc.sh start
      args:
        chdir: "{{ runner_dir }}"

    - name: Verify runner config exists
      stat:
        path: "{{ runner_dir }}/.runner"
      register: runner_cfg

    - name: Fail if runner is not configured
      fail:
        msg: "Runner configuration not found at {{ runner_dir }}/.runner"
      when: not runner_cfg.stat.exists

    - name: Check runner service status
      command: ./svc.sh status
      args:
        chdir: "{{ runner_dir }}"
      register: runner_status
      changed_when: false

    - name: Show runner status
      debug:
        var: runner_status.stdout

    - name: Ensure runner service is running
      assert:
        that:
          - "'is running' in runner_status.stdout"
        fail_msg: "GitHub Actions runner service is not running"
        success_msg: "GitHub Actions runner service is running"
